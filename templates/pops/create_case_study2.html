{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block page_styles %}
<link rel="stylesheet" href="{% static 'css/create_case_study_styles.css' %}">
{% endblock %}

{% block content %}

<div class="container py-4">
  <!--Page title-->
  <h2 class="text-center">Create Case Study</h2>
  <!--Start of form-->
  <form method="post" enctype="multipart/form-data" class="form-horizontal">
    <div class="row justify-content-center">
      <div class="col-md-10 col-lg-8 col-xl-6">
        <!--Announcement at top of page-->
        <div class="alert alert-warning">
          <p>
            <strong>Welcome to the create case study page!</strong> Please be sure to read the
            <a class="" href="{% url 'case_study_help' %}">Case Study Help page</a> before getting started.
          </p>
        </div>

        <!--Warning message that there were errors in the form-->
        {% if error_message %}
        <div class="alert alert-danger text-center" role="alert">
          <strong>Please correct the errors below!</strong>
          <p>Note! You must also reselect any files to upload.</p>
        </div>
        {% endif %}
        <!--CSRF Token-->
        {% csrf_token %}

        <!--Case study form section-->
        <div class="border border-light p-2 my-1">
          <div class="">
            <legend>Case study details</legend>
          </div>
          <!--Most of case study form (defined in Crispy Layout in forms.py)-->
          {% for hidden in case_study_form.hidden_fields %}
          {{ hidden }}
          {% endfor %}

          {% include "pops/include/form_field.html" with field=case_study_form.name %}
          {% include "pops/include/form_field.html" with field=case_study_form.description|attr:"rows:5" %}
          <div class="row">
            {% include "pops/include/form_field.html" with field=case_study_form.start_year form_class="col-6" %}
            {% include "pops/include/form_field.html" with field=case_study_form.end_year form_class="col-6" %}
          </div>
          <div class="row">
            {% include "pops/include/form_field.html" with field=case_study_form.future_years form_class="col-6" %}
            {% include "pops/include/form_field.html" with field=case_study_form.time_step form_class="col-6" %}
          </div>
          <div class="row">
            {% include "pops/include/form_field.html" with field=case_study_form.number_of_pests form_class="col-6" %}
            {% include "pops/include/form_field.html" with field=case_study_form.number_of_hosts form_class="col-6" %}
          </div>
          <div class="row">
            {% include "pops/include/form_field.html" with field=case_study_form.infestation_data|attr:"class:form-control-file" form_class="col-6" %}
            {% include "pops/include/form_field.html" with field=case_study_form.all_plants|attr:"class:form-control-file" form_class="col-6" %}

          </div>
          {% include "pops/include/toggle_switch.html" with field=case_study_form.use_treatment %}
          <div id="treatment_form_visibility">
            {% include "pops/include/form_field.html" with field=case_study_form.treatment_data|attr:"class:form-control-file" %}
          </div>

          <!--Treatment visibility javascript (hides treatment form based on toggle)-->
          <script>
            if ($("#{{ case_study_form.use_treatment.id_for_label }}").is(':checked')){
              $("#treatment_form_visibility").show();}
            else {$("#treatment_form_visibility").hide();}
            $(document).ready(function () {
                var ckbox = $('#{{ case_study_form.use_treatment.id_for_label }}');
                $('input').on('click',function () {
                    if (ckbox.is(':checked')) {$("#treatment_form_visibility").show();} 
                    else {$("#treatment_form_visibility").hide();}
                });
            });
          </script>

        </div>

        <!--Host details form section-->
        <div class="border border-light p-2 my-1">
          <div class="">
            <legend>Host details</legend>
          </div>
          {% for hidden in host_form.hidden_fields %}
          {{ hidden }}
          {% endfor %}

          <div class="row">
            {% include "pops/include/form_field.html" with field=host_form.name form_class="col-6" %}
            {% include "pops/include/form_field.html" with field=host_form.score form_class="col-6" %}
          </div>
          {% include "pops/include/form_field.html" with field=host_form.host_data|attr:"class:form-control-file"  %}
          {% include "pops/include/toggle_switch.html" with field=host_form.mortality_on %}

        </div>

        <!--Submit button for form-->
        <div class="text-center py-2">
          <button class="btn btn-info btn-lg" type="submit">Next</button>
        </div>
        <div class="text-center">
          <span>Note: You will be able to review your case study on the next page before submitting for calibration.</span>
        </div>

      </div>
    </div>

  </form>
  <!--End form-->

</div>
<!--End main container-->

<!--Script to make tooltips appear on hover-->
<script>
  $(document).ready(function () {
    $("body").tooltip({
      selector: '[data-toggle=tooltip]'
    });
  });
</script>
{% endblock %}

{% block scripts %}
<!--Scripts to add/remove reclass rows to temp/precip forms-->
<script src="{% static 'js/jquery.formset.js' %}"></script>
<script>
  $('div#temp_reclass_formset').formset({
    prefix: '{{ temperature_reclass_formset.prefix }}',
    addText: 'Add Row',
    deleteText: 'remove',
    addCssClass: 'btn btn-info',
    deleteCssClass: 'text-light'
  });
</script>

<script>
  $('div#precip_reclass_formset').formset({
    prefix: '{{ precipitation_reclass_formset.prefix }}',
    addText: 'Add Row',
    deleteText: 'remove',
    addCssClass: 'btn btn-info',
    deleteCssClass: 'text-light'
  });
</script>
{% endblock %}