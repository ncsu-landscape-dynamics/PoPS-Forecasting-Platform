<!DOCTYPE html>
<html lang="en">
{% load static %} 

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/bootstrap-theme.min.css' %}">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
    crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'css/base_styles.css' %}">
  <script src="{% static 'js/jquery.min.js' %}"></script>
  <script src="{% static 'js/popper.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'images/favicon-32x32.png' %}">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'images/favicon-16x16.png' %}">

  {% load static %}
  {% block page_styles %}
  <link rel="stylesheet" href="{% static 'css/dashboard_layout.css' %}">
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    {% endblock %}

<script>
  //Colors and patterns for drawing management polygons and plots.
  var colors = ['#d6f731','#4af7b0','#6fd5f7','#c596fa','#fa89d2'];//['#C6F761', '#60f781','#60e8f7','#be89fa','#fa89d2'];//['#C6F761', '#61F785','#61F7E8','#61A4F7','#8D61F7','#E361F7'];
  var host_removal_patterns=['X-LimeGreen','X-BlueGreen','X-Blue','X-Purple','X-Pink',];
  var pesticide_application_patterns=['ColoredDots-LimeGreen','ColoredDots-BlueGreen','ColoredDots-Blue','ColoredDots-Purple','ColoredDots-Pink',];
  var previous_pesticide_application_patterns=['BlackDots-LimeGreen','BlackDots-BlueGreen','BlackDots-Blue','BlackDots-Purple','BlackDots-Pink',];
  //Default variable values for initial load (these may not all be necessary?)
  var acre_to_meter_ratio=0.000247105;
  var max_number=100;
  var max_area=100;
  var max_cost=100;
  var displayed_data_types = ["_forecast","_minimum","_median","_maximum","_mean","_stdev"];

</script>
<!-- FUNCTIONS  -->
<title>PoPS</title>
</head>

<body class="text-light">

  {% block content %}

<div class=" container-fluid p-0 ">
  {% comment %} TOP NAVBAR {% endcomment %}
  <nav class="navbar navbar-expand-lg navbar-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo03"
      aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a href="{% url 'landing_page' %}" class="navbar-brand">
      <img src="{% static 'images/PoPSlogo_simple.svg' %}" style="width: 80px;" class="d-inline-block align-middle "
        alt="Pest or Pathogen Spread Simulation">
    </a>
    <div class="collapse navbar-collapse mb-0 mt-0" id="navbarTogglerDemo03">
      <span id="session_title" class="pb-0 navbar-text d-none d-md-inline-block mr-auto text-bottom">
        <strong>Session:</strong> {{ session.name|truncatechars:55  }}  <a href="#" data-toggle="tooltip"
          title="Edit session name will be available in the future" data-placement="right"><i style="font-size:0.5em;"
            class="fas fa-pencil-alt align-top"></i></a>
        <span id="case_study_title" class="text-muted d-none d-lg-inline-block" style="font-size:0.8em;">
          ({{ session.case_study }} <a
            href="{% url 'case_study_review' pk=session.case_study.pk %}" data-toggle="tooltip"
            title="View case study detail page" data-placement="right"><i style="font-size:0.6em"
              class="fas fa-info-circle align-top text-secondary"></i></a>)
        </span>
      </span>
      <ul class="nav mt-2 mt-lg-0 mb-0 pb-0">
        <li id="share-link" class="nav-item dropdown">
          {% if session.public == True %}
          <a class="nav-link" href="{% url 'session_share' pk=session.pk %}" data-toggle="tooltip"
            title="Edit share settings on this session." data-placement="bottom"><i class="fas fa-unlock-alt"></i>
            Public </a>
          {% elif allowed_users %}
          <a id="sharedDropdownMenuLink" class="nav-link dropdown-toggle" href="#" data-toggle="dropdown"
            title="See shared users" data-placement="bottom"><i class="fas fa-user-friends"></i> Shared </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
            {% for allowed_user in allowed_users %}
            <a class="dropdown-item text-light" href="#">{{ allowed_user.user.username }}</a>
            {% endfor %}
            {% if session.created_by.username == user.username %}
            <a class="dropdown-item" href="{% url 'session_share' pk=session.pk %}" data-toggle="tooltip"
              title="Edit share settings on this session." data-placement="bottom"><i class="fas fa-pencil-alt"></i>
              Edit users... </a>
            {% else %}
            <a class="dropdown-item text-light" href="#">{{ session.created_by.username }} (owner)</a>
            {% endif %}
          </div>
          {% else %}
          <a class="nav-link" href="{% url 'session_share' pk=session.pk %}" data-toggle="tooltip"
            title="Edit share settings on this session." data-placement="bottom"><i class="fas fa-lock"></i> Private
          </a>
          {% endif %}
        </li>
        <li id="main_menu" class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            Menu
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
            <a class="dropdown-item" href="{% url 'workspace' %}">My Workspace</a>
            <a class="dropdown-item" href="#">FAQs</a>
          </div>
        </li>
      </ul>
    </div>
  </nav>
  {% comment %} LEFT SIDE BAR {% endcomment %}
  <div class="row no-gutters">
    <div id="side-bar-container" class="col-auto text-center ">
      <div class="nav " id="side-bar" aria-orientation="vertical">
        <a class="nav-link" id="new-tab" data-toggle="modal" data-target="#editInputParameters" href="#"
          aria-controls="v-pills-new" aria-selected="false"><i class="align-middle fas fa-plus-circle "
            data-toggle="tooltip" title="Create new run" data-placement="right"></i></a>
        <a class="nav-link active" id="map-tab" data-toggle="pill" title="View map" data-placement="right" href="#"
          aria-controls="v-pills-home" aria-selected="true"><i class="align-middle fas fa-globe-americas"></i></a>
        <a class="nav-link" id="chart-view-tab" data-toggle="tooltip"
          title="View detailed analytics for selected run (Coming soon!)" href="#" data-placement="right"
          aria-controls="v-pills-messages" aria-selected="false"><i class=" align-middle fas fa-chart-bar"></i></a>
        <a class="nav-link" id="report-tab" data-toggle="tooltip" title="Generate report (Coming soon!)"
          data-placement="right" href="#" aria-controls="v-pills-messages" aria-selected="false"><i
            class="align-middle fas fa-file-pdf"></i></a>
        <div class="" id="side-bar-filler"> </div>
      </div>
    </div>
    <div id="" class="col">
      <div class="tab-content" id="v-pills-tabContent">
        <div id="v-pills-map" class="tab-pane fade show active no-gutters">
          <div class="row no-gutters">
            <!-- MAP CONTAINER -->
            <div id="map-container-new-view" class="col-md-9">
              <!-- TIMELINE HEADER BUTTONS FOR SUBMITTING RUNS -->
              <div id="timeline" class="text-center">
                <div id="flex-container">
                  <div class="timeline-year-container year-0 management_complete year_active management_visible"
                    data-year-counter=0 data-year-value={{ historic_data.last.year }}
                    data-run-pk={{ session.default_run }}>
                    <div class="timeline-buttons">
                      <span class="completed_management_buttons">
                      </span>
                      <span class="submit_run_button">
                        <a href="#" data-toggle="tool"
                          title="Run PoPS model for **CASE STUDY END YEAR** management."><i
                            class="fas fa-play-circle"></i></a>
                      </span>
                    </div>
                    <div class="timeline-year">
                      <a class="align-top" data-toggle="tool" title="View forecast with no management."
                        href="#">None</a>
                    </div>
                  </div>
                  <div class="timeline-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                  {% for year in steering_years %}
                  <div
                    class="timeline-year-container year-{{forloop.counter}} {% if forloop.first %} management_active {% else %} management_not_started {% endif %} management_visible"
                    data-year-counter={{ forloop.counter }} data-year-value={{ year }} data-run-pk="">
                    <div class="timeline-buttons">
                      <span class="completed_management_buttons">
                        <a class="timeline-edit" href="#" data-toggle="tool"
                          title="Go back to manage year {{ year }}. This will delete all subsequent management years."><i
                            class="fas fa-backspace "></i></a>
                        <a class="timeline-visibility" href="#" data-toggle="tool"
                          title="Toggle management polygon visibility."><i class="far fa-eye "></i></a>
                      </span>
                      <span class="submit_run_button">
                        <button form="submit-run" type="submit" data-toggle="tool"
                          title="Run PoPS model for {{ year }} management."><i
                            class="fas fa-play-circle"></i></button>
                      </span>
                    </div>
                    <div class="timeline-year">
                      <a class="align-top" data-toggle="tool" title="View forecast with management up to {{ year }}."
                        href="#">{{ year }}</a>
                    </div>
                  </div>
                  {% if forloop.last %}
                  {% else %}
                  <div class="timeline-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
                  {% endif %}
                  {% endfor %}
                </div>
              </div>
              <form id="submit-run" method="post" submit-run-url="{% url 'save_run_data' %}">
                {% csrf_token %}
                <input type="hidden" value="0" name="management_polygons" cols="40" rows="10" class="form-control"
                  id="id_management_polygons">
                <input type="hidden" value="2019" name="steering_year" cols="40" rows="10" class="form-control"
                  id="id_steering_year">
                <input type="hidden" value="0" name="management_area" cols="40" rows="10" class="form-control"
                  id="id_management_area">
                <input type="hidden" value="0" name="management_cost" cols="40" rows="10" class="form-control"
                  id="id_management_cost">
                <input type="hidden" value="0" name="run_collection" cols="40" rows="10" class="form-control"
                  id="id_run_collection">
              </form>              
              <!-- MAP -->
              <div id="map" class="large_map"></div>
              <button id="show_details_button" type="button" class="btn" style="display: none" data-toggle="tool"
                title="Show details."><i class="fas fa-chevron-left"></i></button>
              <!-- MAP LEGEND -->
              <div id="displayed-data-legend-container">
                <div id="legend-container" data-toggle="tool" title="Legend for currently displayed data">
                  <div class="my-0">
                    <strong id="display_year_forecast">Field observations </strong>
                    <small id="legend_description"> (Number of detections)</small>
                  </div>
                  <div id="historic-legend-container" class="my-0">
                    <div style="height: 20px; width: 280px;">
                      <span class="legend-label mr-1">0</span>
                      <div class="legend-color" style="background-color:#CC0000; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#D61900; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#E03300; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#EA4C00; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#F46600; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FF8000; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FF9F19; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FFBF33; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FFDF4C; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FFFF66; opacity:0.85"></div>
                      <div class="legend-color" style="background-color:#FFFFCC; opacity:0.9"></div>
                      <div class="legend-label ml-1">{{ session.max_value }}+</div>
                      <div style="clear: left;">
                      </div>
                    </div>
                  </div>
                  <div id="occurence-legend-container" class="my-0">
                    <div style="height: 20px; width: 280px;">
                      <span class="legend-label mr-1">0</span>
                      <div class="legend-color" style="background-color:#CC0000; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#D61900; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#E03300; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#EA4C00; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#F46600; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FF8000; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FF9F19; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FFBF33; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FFDF4C; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FFFF66; opacity:0.8"></div>
                      <div class="legend-color" style="background-color:#FFFFCC; opacity:0.8"></div>
                      <div class="legend-label ml-1">{{ session.max_value }}+</div>
                      <div style="clear: left;">
                      </div>
                    </div>
                  </div>
                  <div id="probability-legend-container" class="my-0">
                    <div style="height: 20px; width: 280px;">
                      <span class="legend-label mr-1">0</span>
                      <div class="legend-color" style="background-color:#000005; opacity:0.467"></div>
                      <div class="legend-color" style="background-color:#080616; opacity:0.5"></div>
                      <div class="legend-color" style="background-color:#1E0848; opacity:0.533"></div>
                      <div class="legend-color" style="background-color:#43006A; opacity:0.567"></div>
                      <div class="legend-color" style="background-color:#6B116F; opacity:0.6"></div>
                      <div class="legend-color" style="background-color:#981D69; opacity:0.633"></div>
                      <div class="legend-color" style="background-color:#C92D59; opacity:0.676"></div>
                      <div class="legend-color" style="background-color:#ED504A; opacity:0.7"></div>
                      <div class="legend-color" style="background-color:#FA8657; opacity:0.733"></div>
                      <div class="legend-color" style="background-color:#FBC17D; opacity:0.767"></div>
                      <div class="legend-color" style="background-color:#FCFFB2; opacity:0.8"></div>
                      <div class="legend-label ml-1">100%</div>
                      <div style="clear: left;">
                      </div>
                    </div>
                  </div>
                </div>
                <div id="year-slider-container" data-toggle="tool" title="Currently displayed year">
                  <div id="display_year_label" class="py-0 ">
                    <output id="displayYear">{{ historic_data.last.year }}</output>
                  </div>
                  <div id="year-slider" class="range range-info">
                    <div class="slider-bar">
                      <div class="slider-bar-colors historic-years" style="width: 55px;"></div>
                      <div class="slider-bar-colors managed-years" style="width: 2px;"></div>
                      <div class="slider-bar-colors forecast-years"></div>
                    </div>
                    <input class="year-range" type="range" name="range" min="{{ historic_data.0.year }}"
                      max="{{ historic_data.last.year }}" step="1" value="{{ historic_data.last.year }}"
                      onchange="displayYear.value=value">
                  </div>
                </div>
                <button id="show_display_options_button" type="button" class="btn btn-sm" data-toggle="tool"
                  title="Display options"><i class="fas fa-layer-group"></i> <i id="display_options_button_icon"
                    class="fas fa-chevron-down"></i></button>
                <!-- DISPLAY OPTIONS PANEL -->
                <div id="display-options-panel" class="">
                  <div id="displayed-data-options" class="p-2 border border-secondary">
                    <div>Displayed forecast data:</div>
                    <div class="form-check">
                      <input class="form-check-input" value="_forecast" type="radio" name="displayed_data_type"
                        id="display_forecast" data-name="Forecast">
                      <label class="form-check-label" for="display_forecast">
                        Probability of occurence
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" value="_mean" type="radio" name="displayed_data_type"
                        id="display_mean" data-name="Mean">
                      <label class="form-check-label" for="display_mean">
                        Mean detections
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" value="_minimum" type="radio" name="displayed_data_type"
                        id="display_minimum" data-name="Minimum">
                      <label class="form-check-label" for="display_minimum">
                        Minimum detections
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" value="_maximum" type="radio" name="displayed_data_type"
                        id="display_max" data-name="Maximum">
                      <label class="form-check-label" for="display_max">
                        Maximum detections
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" value="_stdev" type="radio" name="displayed_data_type"
                        id="display_stdev" data-name="Standard deviation">
                      <label class="form-check-label" for="display_stdev">
                        Standard deviation detections
                      </label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" value="_median" type="radio" name="displayed_data_type"
                        id="display_median" data-name="Median" checked>
                      <label class="form-check-label" for="display_median">
                        Current simulated state
                      </label>
                    </div>
                  </div>
                  <div id="optional-layers-options" class="p-2 border border-secondary">
                    <div>Optional layers:</div>
                    <!-- MAP ADDITIONAL LAYER CHECKBOXES -->
                    <div id="host_map_checkbox" class="form-check">
                      <input class="form-check-input" type="checkbox" value="" checked>
                      <label class="form-check-label" for="host_map_checkbox">
                        Host map
                      </label>
                    </div>
                    <div id="intermodal_passenger_checkbox" class="form-check">
                      <input class="form-check-input" type="checkbox" value="">
                      <label class="form-check-label" for="intermodal_passenger_checkbox">
                        Intermodal passenger travel
                      </label>
                    </div>
                    <div id="railroad_lines_checkbox" class="form-check">
                      <input class="form-check-input" type="checkbox" value="">
                      <label class="form-check-label" for="railroad_lines_checkbox">
                        Railroads
                      </label>
                    </div>
                    <div id="intermodal_freight_checkbox" class="form-check">
                      <input class="form-check-input" type="checkbox" value="">
                      <label class="form-check-label" for="intermodal_freight_checkbox">
                        Intermodal freight
                      </label>
                    </div>
                    <div id="airports_checkbox" class="form-check">
                      <input class="form-check-input" type="checkbox" value="">
                      <label class="form-check-label" for="airports_checkbox">
                        Airports
                      </label>
                    </div>
                    <div id="seaports_checkbox" class="form-check">
                      <input class="form-check-input" type="checkbox" value="">
                      <label class="form-check-label" for="seaports_checkbox">
                        Seaports
                      </label>
                    </div>
                    <div id="truck_parking_checkbox" class="form-check">
                      <input class="form-check-input" type="checkbox" value="">
                      <label class="form-check-label" for="truck_parking_checkbox">
                        Truck parking
                      </label>
                    </div>
                  </div>
                </div> <!-- End DISPLAY OPTIONS -->

              </div>









              <!-- BUDGET PLOT --> 
              <div id="budget_background_layer">
                <div id="displayed_management_area" class="text-center">
                  <div>Managed area:</div>
                  <div id="displayed-management-area">0.0 acres</div>
                </div>                
              </div>
              <div id="current-budget-plot" class=""></div>
              <!-- DRAW CONTROLS -->
              <div id="draw-controls" class="btn-group-vertical" role="group">
                <button id="reset-view-tool" class="btn btn-default" type="button" data-toggle="tool"
                  title="Reset view" data-placement="left">
                  <i class="fas fa-crosshairs"></i>
                </button>            
                <div class="btn-group dropleft" title="Displayed units">
                  <button type="button" class="btn btn-default dropdown-toggle dropdown-toggle-split "
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  </button>
                  <button id="area_unit_button" type="button" data-toggle="dropdown" class="btn btn-default">
                    <div id="area_unit_text">ac</div>
                  </button>
                  <div class="dropdown-menu draw-tool-dropdown">
                    <div class="px-2 py-1">Displayed units:</div>
                    <div class="container">
                      <div class="row">
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm">
                            <select name="area_unit" class="form-control" id="id_area_unit">
                              <option data-text="m<sup>2</sup>" value="1">meter squared</option>
                              <option data-text="ac" value="0.000247105" selected>acre</option>
                              <option data-text="ha" value="0.0001">hectare</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <button class="btn btn-secondary btn-sm" type="button" data-toggle="tool" title="Select management type"
                  data-placement="left">
                  <small>Management</small>
                </button>
                <div class="btn-group dropleft">
                  <button type="button" title="Host removal"
                    class="btn btn-default dropdown-toggle dropdown-toggle-split " data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                  </button>
                  <button type="button" class="btn btn-default" title="Host removal">
                    <i class="fas fa-window-close"></i> <input class="management-type" type="checkbox"
                      value="host_removal" id="host_removal_status" {% if session.default_management_type == 'HOST_REMOVAL' %} checked {% endif %}>
                  </button>
                  <div class="dropdown-menu draw-tool-dropdown">
                    <div class="px-2 py-1">Host removal:</div>
                    <div class="container">
                      <div class="row">
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm" title="Host removal date">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Date</span>
                            </div>
                            <input id="default_host_removal_date" class="form-control management-date" type="date"
                              name="host_removal_date" value="{{steering_years | first }}-{{ session.default_host_removal_month|stringformat:'02i' }}-{{ session.default_host_removal_day|stringformat:'02i' }}" min="{{steering_years | first }}-01-01" max="{{steering_years | first }}-12-31">
                          </div>
                        </div>                      
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm" title="Host removal efficacy (range: 0-1)">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Efficacy</span>
                            </div>
                            <input id="default_host_removal_efficacy" class="form-control" type="number"
                              name="host_removal_efficacy" value="1" min="0" max="1" step="0.1">
                          </div>
                        </div>
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm management_group_cost" title="Host removal cost per selected unit area">
                            <div class="input-group-prepend">
                              <span class="input-group-text">$</span>
                            </div>
                            <input class="displayed_cost form-control" type="number" name="displayed_host_removal_cost"
                              value="4000" min="0" step="1">
                            <input hidden id="default_host_removal_cost" class="default_cost" type="number"
                              name="host_removal_cost_per_m2" value="0.98842" min="0">
                            <select class="custom-select custom-select-sm cost_unit">
                              <option value="1">/m^2</option>
                              <option value="0.000247105" selected>/acre</option>
                              <option value="0.0001">/ha</option>
                            </select>
                          </div>
                        </div>
                        <input hidden id="default_host_removal_duration" class="form-control management_duration" type="number"
                          name="host_removal_duration" value="0" min="0" step="1"
                          title="Host removal duration">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="btn-group dropleft">
                  <button type="button" title="Pesticide" class="btn btn-default dropdown-toggle dropdown-toggle-split "
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  </button>
                  <button type="button" class="btn btn-default" title="Pesticide">
                    <i class="fas fa-spray-can"></i> <input class="management-type " type="checkbox" value="pesticide"
                      id="pesticide_status" {% if session.default_management_type == 'PESTICIDE' %} checked {% endif %}>
                  </button>
                  <div class="dropdown-menu draw-tool-dropdown">
                    <div class="px-2 py-1">Pesticide:</div>
                    <div class="container pesticide-info">
                      <div class="row">
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm pesticide-type" title="Select a pesticide">
                            <select id="default_pesticide_type" class="custom-select">
                        {% for pesticidelink in pesticidelinks %}
                        <option 
                        {% if forloop.first %} selected {% endif %}
                        value="{{ pesticidelink.pesticide.pk }}" 
                        data-efficacy="{{ pesticidelink.efficacy }}" 
                        data-application-efficacy="{{ pesticidelink.application_efficacy }}" 
                        data-application-date="{{steering_years | first }}-{{ pesticidelink.default_application_month|stringformat:'02i' }}-{{ pesticidelink.default_application_day|stringformat:'02i' }}"
                        data-duration="{{ pesticidelink.pesticide.duration }}" 
                        data-cost-per-m2="{{ pesticidelink.pesticide.cost_per_meter_squared }}"
                        data-cost-per-acre="{{ pesticidelink.pesticide.cost_per_acre }}"
                        >
                        {{ pesticidelink.pesticide.trade_name }}
                        </option>
                        {% endfor %}                              
                              <option value="other">Other (enter efficacy and duration)</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm" title="Pesticide application date">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Date</span>
                            </div>
                            <input id="default_pesticide_date" class="form-control management-date" type="date"
                              name="pesticide_date" value="{{steering_years | first }}-{{ pesticidelinks.first.default_application_month|stringformat:'02i' }}-{{ pesticidelinks.first.default_application_day|stringformat:'02i' }}" min="{{steering_years | first }}-01-01" max="{{steering_years | first }}-12-31">
                          </div>
                        </div>                               
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm" title="Pesticide efficacy (range: 0-1)">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Efficacy</span>
                            </div>
                            <input disabled id="default_pesticide_efficacy" class="form-control efficacy" type="number"
                              name="pesticide_efficacy" value="{{ pesticidelinks.first.efficacy }}" min="0" max="1" step="0.01"
                              title="Pesticide efficacy (range: 0.0 - 1.0)">
                          </div>
                        </div>                            
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm" title="Pesticide application efficacy (range: 0-1)">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Application Efficacy</span>
                            </div>
                            <input id="default_pesticide_application_efficacy" class="form-control application-efficacy" type="number"
                              name="pesticide_application_efficacy" value="{{ pesticidelinks.first.application_efficacy }}" min="0" max="1" step="0.01"
                              title="Pesticide application efficacy (range: 0.0 - 1.0)">
                          </div>
                        </div>    
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm" title="Pesticide duration">
                            <div class="input-group-prepend">
                              <span class="input-group-text">Duration</span>
                            </div>
                            <input disabled id="default_pesticide_duration" class="form-control management_duration" type="number"
                              name="pesticide_duration" value="{{ pesticidelinks.first.pesticide.duration }}" min="0" step="1"
                              title="Pesticide duration">
                            <div class="input-group-append">
                              <span class="input-group-text">days</span>
                            </div>                          
                          </div>
                        </div>                                         
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm management_group_cost" title="Pesticide cost per selected unit area">
                            <div class="input-group-prepend">
                              <span class="input-group-text">$</span>
                            </div>
                            <input class="displayed_cost form-control" type="number" name="displayed_pesticide_cost"
                              value="{{ pesticidelinks.first.pesticide.cost_per_acre }}" min="0" step="1">
                              {% comment %} Needs to come from database {% endcomment %}
                            <input hidden id="default_pesticide_cost" class="default_cost" type="number"
                              name="pesticide_cost_per_m2" value="{{ pesticidelinks.first.pesticide.cost_per_meter_squared }}" min="0"> 
                            <select class="custom-select custom-select-sm cost_unit">
                              <option value="0.000247105" selected>/acre</option>
                              <option value="1">/m^2</option>
                              <option value="0.0001">/ha</option>
                            </select>
                          </div>
                        </div>                    
                      </div>
                    </div>
                  </div>
                </div>


                <button class="btn btn-secondary btn-sm " type="button" data-toggle="tool"
                  title="Below are the tools to draw management" data-placement="left">
                  <small>Draw tools</small>
                </button>
                <button id="polygon-tool" class="btn btn-default drawing-tool " type="button" data-toggle="tool"
                  title="Draw management polygon" data-placement="left">
                  <i class="fas fa-draw-polygon"></i>
                </button>
                <div id="circle-tool-group" class="btn-group dropleft">
                  <button type="button" class="btn btn-default dropdown-toggle dropdown-toggle-split "
                    title="Select radius" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  </button>
                  <button id="circle-tool" type="button" class="btn btn-default drawing-tool" title="Circle tool"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="far fa-dot-circle"></i>
                  </button>
                  <div class="dropdown-menu draw-tool-dropdown">
                    <div class="px-2 py-1">Choose circle radius:</div>
                    <div class="container">
                      <div class="row">
                        <div class="col-12 px-2 py-1">
                          <div class="input-group input-group-sm" title="Circle radius">
                            <input id="displayed_circle_radius" class="displayed_circle_radius form-control"
                              type="number" name="displayed_circle_radius" value="600" min="0" step="1">
                            <input hidden id="circle_radius_in_meters" type="number" name="circle_radius_in_meters" value="600">
                            <select id="circle_distance_unit" class="custom-select custom-select-sm">
                              <option value="1.0" selected>meters</option>
                              <option value="0.3048">feet</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <button id="select-tool" class="btn btn-default drawing-tool active" type="button" data-toggle="tool"
                  title="Selection tool" data-placement="left">
                  <i class="fas fa-hand-paper"></i>
                </button>
                <button id="delete-tool" class="btn btn-default drawing-tool" type="button" data-toggle="tool"
                  title="Delete selection" data-placement="left">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
              <script>
                              
                $('#historic-legend-container').show();
                $('#occurence-legend-container').hide();
                $('#probability-legend-container').hide();
                $('#eradication_container').hide();
                $('#display-options-panel').hide();

              </script>
              <!-- STATUS INDICATORS -->
              <div id="status-indicator-shading">
              </div>
              <div id="tangible-landscape-indicator" class="text-center">Waiting for Tangible Landscape...</div>
              <div id="tangible-landscape-listener-button"><a href="#" data-value='true'>Stop Listening</a></div>
              <div id="status-indicator" class="text-center">
                <a id="status-close-button" href="#">&times;</a>
                <div id="status-logo">
                  <img class="rounded-circle" src="{% static 'images/PoPS_AnimatedLogo_TransparentBackground.gif' %}"
                    alt="Generic placeholder image" width="180">
                </div>
                <div id="status-text">
                  <span>Loading...</span>
                </div>
                <button id="cancel-polling" class="btn btn-dark" type="button" data-value='false'>Cancel</button>
              </div>
              <div id="eradication-status-indicator" class="text-center">
                <div id="eradication_container" class="">
                  Eradication successful in <span></span> <sup><a id="eradication-status-close-button"
                      href="#">&times;</a></sup>

                </div>
              </div>
              <!-- EDIT POLYGON POP UP BOX -->
              <div id="editPolygons" class="container">
                <div class="row">
                  <div class="col-12">
                    Edit selected polygons:
                  </div>
                  <div id="edit_management_type" class="col-12">
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="editManagementOptions" id="inlineRadio1"
                        value="Host removal">
                      <label class="form-check-label" for="inlineRadio1"><small>Host removal</small></label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="radio" name="editManagementOptions" id="inlineRadio2"
                        value="Pesticide">
                      <label class="form-check-label" for="inlineRadio2"><small>Pesticide</small></label>
                    </div>
                  </div>
                </div>
                <div class="row pesticide-info">
                  <div id="edit_pesticide_type_group" class="col-12 px-2 py-1">
                    <div class="input-group input-group-sm pesticide-type" title="Select a pesticide">
                      <select id="edit_pesticide_type" class="custom-select">
                        {% for pesticidelink in pesticidelinks %}
                        <option 
                        {% if forloop.first %} selected {% endif %}
                        value="{{ pesticidelink.pesticide.pk }}" 
                        data-efficacy="{{ pesticidelink.efficacy }}"
                        data-application-efficacy="{{ pesticidelink.application_efficacy }}" 
                        data-application-date="{{steering_years | first }}-{{ pesticidelink.default_application_month|stringformat:'02i' }}-{{ pesticidelink.default_application_day|stringformat:'02i' }}"
                        data-duration="{{ pesticidelink.pesticide.duration }}" 
                        data-cost-per-m2="{{ pesticidelink.pesticide.cost_per_meter_squared }}"
                        >
                        {{ pesticidelink.pesticide.trade_name }}
                        </option>
                        {% endfor %} 
                        <option value="other">Other (enter efficacy and duration)...</option>
                      </select>
                    </div>
                  </div>     
                  <div class="col-12 py-1">
                    <div class="input-group input-group-sm" title="Date">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Date</span>
                      </div>
                      <input id="edit_date" class="form-control management-date" type="date"  title="Date" value="{{steering_years | first }}-01-01" min="{{steering_years | first }}-01-01" max="{{steering_years | first }}-12-31">
                    </div>
                  </div>                                 
                  <div class="col-12 py-1">
                    <div class="input-group input-group-sm" title="Efficacy (range: 0-1)">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Efficacy</span>
                      </div>
                      <input id="edit_efficacy" class="form-control efficacy" type="number" name="" value="0.5" min="0" max="1"
                        step="0.1" title="Efficacy (0-1)">
                    </div>
                  </div> 
                  <div id="edit_application_efficacy_group" class="col-12 py-1">
                    <div class="input-group input-group-sm" title="Application Efficacy (range: 0-1)">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Application efficacy</span>
                      </div>
                      <input id="edit_application_efficacy" class="form-control application-efficacy" type="number" name="" value="0.5" min="0" max="1"
                        step="0.1" title="Applicaiton efficacy (0-1)">
                    </div>
                  </div>                     
                  <div class="col-12 py-1">
                    <div class="input-group input-group-sm management_group_cost" title="Cost per selected unit area">
                      <div class="input-group-prepend">
                        <span class="input-group-text">$</span>
                      </div>
                      <input id="edit_display_cost" class="displayed_cost form-control" type="number"
                        name="displayed_pesticide_cost" value="1000" min="0" step="1">
                      <input hidden id="edit_cost" class="default_cost" type="number" name="pesticide_cost_per_m2"
                        value="0.247105" min="0">
                      <select id="edit_area_unit" class="custom-select custom-select-sm cost_unit">
                        <option value="1">/m^2</option>
                        <option value="0.000247105" selected>/acre</option>
                        <option value="0.0001">/ha</option>
                      </select>
                    </div>
                  </div>
                  <div id="edit_duration_group" class="col-12 py-1">
                    <div class="input-group input-group-sm" title="Pesticide duration">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Duration</span>
                      </div>
                      <input id="edit_duration" class="form-control management_duration" type="number" name="" value="0" min="0" 
                        step="1" title="Duration">
                      <div class="input-group-append">
                        <span class="input-group-text">days</span>
                      </div>                    
                    </div>
                  </div>                  
                  <div class="col-12 py-1">
                    <button id="changeManagementButton" class="btn btn-sm btn-info">Apply changes </button>
                  </div>
                </div>
              </div>
<script>
function updatePesticideType(element) {
  console.log('Updating pesticide info.')
  new_efficacy = $(element).find(".pesticide-type option:selected").data("efficacy");
  new_application_efficacy = $(element).find(".pesticide-type option:selected").data("application-efficacy");
  new_application_date = $(element).find(".pesticide-type option:selected").data("application-date");
  new_duration = $(element).find(".pesticide-type option:selected").data("duration");
  new_cost_per_m2 = $(element).find(".pesticide-type option:selected").data("cost-per-m2");
  new_cost_per_acre = $(element).find(".pesticide-type option:selected").data("cost-per-acre");
  if ($(element).find(".pesticide-type option:selected").val() != 'other') {
    $(element).find("input.efficacy").val(new_efficacy).prop('disabled', true);
    $(element).find("input.application-efficacy").val(new_application_efficacy);
    $(element).find("input.management-date").val(new_application_date);
    $(element).find("input.management_duration").val(new_duration).prop('disabled', true);
    $(element).find("input.default_cost").val(new_cost_per_m2);
    $(element).find("input.displayed_cost").val(new_cost_per_acre);
    $(element).find("select.cost_unit").val(0.000247105);
  }
  else {
    $(element).find("input.efficacy").prop('disabled', false);
    $(element).find("input.management_duration").prop('disabled', false);
  }
};
$(".pesticide-type select").on("change", function() {
  console.log('Pesticide selection changed');
  element = $(this).parents(".pesticide-info");
  updatePesticideType(element);
});

//DISPLAYED DATA CHANGE
$("#displayed-data-options input").on("change", function() {
  console.log('Displayed data type changed');
  update_displayed_data();
  //Hide all other types

  //Display the current type and year

});

</script>
              <script>
              $('input[name="editManagementOptions"]').on('change', function() {
                if ($('input[name="editManagementOptions"]:checked').val() == "Pesticide") {
                  if ($(this).next(".pesticide-info").find(".pesticide-type option:selected").val() != 'other') {
                    console.log('Pesticide type is selected')
                    disableEditingPolygonProperties();                
                  }
                  $( "#edit_duration_group" ).show("fast");
                  $( "#edit_pesticide_type_group" ).show("fast");
                }
                else {
                  $( "#edit_duration_group" ).hide("fast");
                  $( "#edit_pesticide_type_group" ).hide("fast");
                  enableEditingPolygonProperties ();
                }
              })
              
              $("#editPolygons").hide();
              $("#tangible-landscape-indicator").hide();
              $("#tangible-landscape-listener-button").hide();
              $("#eradication-status-indicator").hide();
              $("a#eradication-status-close-button").on('click', function () {
                $("#eradication-status-indicator").hide();
              });
              $("button#cancel-polling").hide();
              $("button#cancel-polling").on('click', function () {
                $(this).attr('data-value', 'true');
                console.log("Cancel polling clicked.");
                $(this).hide();
              });
              $("a#status-close-button").on('click', function () {
                console.log("Close button clicked.");
                $("#status-indicator-shading").hide();
                $("#status-indicator").hide();
              });
              </script>
            </div> <!-- End map-container-new-view -->
            <!-- RIGHT SIDE PANEL -->
            <div id="side-panel" class="d-none d-md-block col-md-3 p-1">
              <div id="run-details">
                <!-- New Run Collection Modal -->
                <div class="modal fade" id="editInputParameters" tabindex="-1" role="dialog"
                  aria-labelledby="editInputParameters" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">New Run Parameters</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <form id="submit-run-collection" method="post"
                          submit-run-collection-url="{% url 'save_run_collection_data' %}">
                          {% csrf_token %}
                          {{ form.session.as_hidden }}
                          <div class="row">
                            {% include "pops/include/form_field.html" with field=form.name form_class="col-12" %}
                            {% include "pops/include/form_field.html" with field=form.description form_class="col-12" %}
                            <div class="form-group col-6">
                              <label for="id_budget">Budget ($US)</label>
                              <div class="input-group">
                                <div class="input-group-prepend">
                                  <span class="input-group-text">$</span>
                                </div>
                                <input type="number" name="budget" value="350000" min="0" step="0.01"
                                  data-toggle="tooltip" data-placement="top" title="Allowed budget"
                                  data-container="body" class="form-control" id="id_budget">
                              </div>
                            </div>
                            {% include "pops/include/form_field.html" with field=form.random_seed form_class="col-6" %}
                            <div class="form-check col ml-2 invisible">
                              {{ form.tangible_landscape }}
                              <label class="form-check-label" for="tangible_landscape">
                                Use tangible landscape for management?
                              </label>
                            </div>
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button id="submit_run_collection_button" form="submit-run-collection"
                          type="submit">Submit</button>
                      </div>
                    </div>
                  </div>
                </div> <!-- End run collection modal -->
                <!-- Side panel top button row -->
                <div class="">
                  <button id="hide_details_button" type="button" class="btn" data-toggle="tool"
                    title="Hide details."><i class="fas fa-chevron-right"></i></button>
                  <div id="side-panel-buttons" class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#viewParameters"
                      title="View run and session details."><i class="fas fa-info"></i></button>
                    <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#editInputParameters"
                      title="Start a new run collection in this session."><i class="fas fa-plus"></i></button>
                    <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#edit_run_name_modal"
                      title="Edit this run collection's name and description."><i
                        class="fas fa-pencil-alt"></i></button>
                    <button type="button" class="btn btn-sm" id="" data-toggle="tool"
                      title="Duplicate this run. (Coming Soon)"><i class="fas fa-copy"></i></button>
                    <button type="button" class="btn btn-sm" data-toggle="tool"
                      title="Go to the PoPS instructions. (Coming Soon)"><i class="fas fa-question"></i></button>
                  </div>
                </div>
                <div id="run-collection-name" data-run-collection-pk=0>
                  <strong>Run name:</strong> <span></span>
                </div>
                <!-- Run details Modal -->
                <div class="modal fade" id="viewParameters" tabindex="-1" role="dialog"
                  aria-labelledby="viewParameters" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Run details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <h5>Run collection details</h5>
                        <div id="input_run_name">
                          Name: <span></span>
                        </div>
                        <div id="input_run_pk">
                          Primary key: <span></span>
                        </div>
                        <div id="input_description">
                          Description: <span></span>
                        </div>
                        <div id="input_status">
                          Status: <span></span>
                        </div>
                        <div id="input_random_seed">
                          Random Seed: <span></span>
                        </div>
                        <div id="input_date_created">
                          Date: <span></span>
                        </div>
                        <div id="input_budget">
                          Budget: $<span></span>
                        </div>
                        <div id="input_tangible_landscape">
                          Tangible landscape: <span></span>
                        </div>
                        <h5 class="pt-4">Session details</h5>
                        <div id="input_session_name">
                          Session name: <span>{{ session.name }}</span>
                        </div>
                        <div id="input_session_description">
                          Session description: <span>{{ session.description }}</span>
                        </div>
                        <div id="input_case_study_name">
                          Case study name: <span>{{ session.case_study.name }}</span>
                        </div>
                        <div id="input_reproductive_rate">
                          Reproductive rate: <span>{{ session.reproductive_rate }}</span>
                        </div>
                        <div id="input_distance_scale">
                          Distance Scale: <span>{{ session.distance_scale }}</span>
                        </div>
                        <div id="input_weather">
                          Weather: <span>{{ session.weather }}</span>
                        </div>
                        <div id="input_management_month">
                          Management month: <span>{{ session.management_month }}</span>
                        </div>
                        <div id="input_final_year">
                          Final year: <span>{{ session.final_year }}</span>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Edit run collection name and description modal -->
                <div class="modal fade" id="edit_run_name_modal" tabindex="-1" role="dialog"
                  aria-labelledby="edit run collection name and description" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Run details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <h5>Edit run collection name and description</h5>
                        <div class="row">
                          <div class="form-group col-12">
                            <label for="new_run_collection_name">Run name</label>
                            <div class="input-group ">
                              <input type="text" name="name" maxlength="45" class="form-control" required
                                id="new_run_collection_name" value="">
                            </div>
                          </div>
                          <div class="form-group col-12">
                            <label for="new_run_collection_description">Run description</label>
                            <div class="input-group ">
                              <textarea name="description" cols="40" rows="10" maxlength="300" data-toggle="tooltip"
                                data-placement="top" title="Give your run a description." data-container="body"
                                class="form-control" id="new_run_collection_description">Give your run a description. 
                              </textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button id ="edit_run_collection" type="button" class="btn btn-secondary" data-dismiss="modal">Save and Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Run collection analytics plots -->
                <div id="budget_plot" style="width:100%; height:140px;"></div>
                <div id="area_infected_side_plot" style="width:100%; height:180px;"></div>
                <div id="number_infected_side_plot" style="width:100%; height:180px;"></div>
{% comment %}                 <div id="spread_rate_title"><span></span> spread rate (m/year):</div>
                <div id="spread_plot" style="width:100%; height:220px;"></div>       {% endcomment %}
              </div>    <!-- End run-details -->            
            </div> <!-- End SIDE PANEL -->    
          </div><!-- End row -->
        </div> <!-- End tab pane v-pills-map-->
        <script>
        $('#editInputParameters').modal('show');
        </script>

      </div> <!-- End tab-content -->
    </div> <!-- End col-->
  </div> <!-- End row (this contains the side bars and map)-->
  <div id="run-preview-description" class="row no-gutters">
    <div class="col">
      Other runs in this session:
    </div>
  </div><!-- End row-->
  <!-- BOTTOM PANEL: OTHER RUN BUTTONS-->
  <div id="run-preview-container" class="row no-gutters flex-nowrap"></div>
</div><!-- End container-->

{% endblock %}

{% block scripts %}
<script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.css'
    type='text/css' />
<!-- CUSTOM CIRCLE DRAWING MODE -->
<script src="{% static 'js/dashboard/CircleMode.js' %}"></script>
<!-- Set the draw color and pattern fills for the draw tools -->
<script src="{% static 'js/dashboard/setDrawColor.js' %}"></script>
<script src="{% static 'js/dashboard/gaugePlot.js' %}"></script>
<script src="{% static 'js/dashboard/ajax_setup_functions.js' %}"></script>
<script src="{% static 'js/dashboard/mapbox_layer_functions.js' %}"></script>
<script src="{% static 'js/dashboard/side_bar_plots.js' %}"></script>
<!-- This is the plotting function for the comparison buttons at the bottom.  -->
<script src="{% static 'js/dashboard/run_comparison_plot.js' %}"></script>
<!-- Function to insert a run button.  -->
<script src="{% static 'js/dashboard/insertRunButton.js' %}"></script>
<!-- Function to update mapbox draw color.  -->
<script src="{% static 'js/dashboard/updateDrawColor.js' %}"></script>
<script src="{% static 'js/dashboard/draw_functions.js' %}"></script>
<script src="{% static 'js/websockets/rpc-websockets.js' %}"></script>

{% for run_collection in run_collections %}
<script>
  insertRunButton('{{ run_collection.pk }}','{{ run_collection.name }}','{{run_collection.date_created}}','{{run_collection.description}}',{{ run_collection.number_infected }},{{ run_collection.infected_area }},{{run_collection.overall_cost}});
</script>
{% endfor %} 

<script>
//TIMELINE BUTTONS 
                  $(".timeline-year a").on('click', function () {
                    if (!$(this).parents(".timeline-year-container").hasClass("year_active")) {
                      if ($(this).parents(".timeline-year-container").hasClass("management_complete")) {
                        console.log("Updating displayed results to selected year of management.")
                        var run_id = $(this).parents(".timeline-year-container").attr('data-run-pk');
                        $(".timeline-year-container").removeClass("year_active");
                        $(this).parents(".timeline-year-container").addClass("year_active");
                        get_output(run_id);
                      };
                    };
                  });

                  $(".timeline-visibility").on('click', function () {
                    var year_value = $(this).parents(".timeline-year-container").attr('data-year-value');
                    var treatment_outline = (year_value.toString() + "_management");
                    var treatment_fill = (year_value.toString() + "_fill");
                    if ($(this).parents(".timeline-year-container").hasClass("management_visible")) {
                      $(this).parents(".timeline-year-container").removeClass("management_visible").addClass("management_hidden");
                      $(this).children("i").removeClass("fa-eye").addClass("fa-eye-slash");
                      map.setLayoutProperty(treatment_fill, 'visibility', 'none');
                    } else {
                      $(this).parents(".timeline-year-container").removeClass("management_hidden").addClass("management_visible");
                      $(this).children("i").removeClass("fa-eye-slash").addClass("fa-eye");
                      map.setLayoutProperty(treatment_fill, 'visibility', 'visible');
                    }
                  });

                  //THIS ONLY WORKS FOR THE ACTIVE USER RIGHT NOW
                  $(".timeline-edit").on('click', function () {
                    console.log("Attempting to delete runs...")
                    $(this).parents(".timeline-year-container").removeClass("management_complete").removeClass("year_active").addClass("management_active").removeClass("management_hidden").addClass("management_visible");
                    $(this).next(".timeline-visibility").children("i").removeClass("fa-eye-slash").addClass("fa-eye");
                    $(this).parents(".timeline-year-container").nextAll(".timeline-year-container").removeClass("management_active").removeClass("management_complete").removeClass("year_active").addClass("management_not_started").removeClass("management_hidden").addClass("management_visible");
                    $(this).parents(".timeline-year-container").nextAll(".timeline-year-container").find(".timeline-visibility").children("i").removeClass("fa-eye-slash").addClass("fa-eye");
                    $(this).parents(".timeline-year-container").prev().prev(".timeline-year-container").addClass("year_active");
                    var year_count = $(this).parents(".timeline-year-container").attr('data-year-counter');
                    var run_id = $(this).parents(".timeline-year-container").attr('data-run-pk');
                    var previous_run_id = $(this).parents(".timeline-year-container").prev().prev(".timeline-year-container").attr('data-run-pk');
                    var run_collection_id = $('#run-collection-name').attr('data-run-collection-pk');
                    $.ajax({
                      url: "{% url 'delete_runs' %}",
                      dataType: "json",
                      data: {
                        'run_id': run_id,
                        'run_collection': run_collection_id,
                      },
                      success: function (data) {
                        console.log('Runs greater than or equal to ' + data.run_id + ' were deleted.');
                        get_output(previous_run_id);
                      },
                      error: function (xhr, errmsg, err) {
                        alert("An error occured deleting the runs. An error has occured: " + xhr.status + "\nError: " + xhr.responseText +
                          "\n");
                        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                      }
                    });
                    updateDrawColor(year_count);
                  });


//DRAW TOOLS
  $("#polygon-tool").on('click', function () {
    $('.drawing-tool').removeClass('active');
    $(this).addClass('active');
    draw.changeMode('draw_polygon');
    console.log("Polygon tool selected.")
  });

    $("#circle-tool").on('click', function () {
      $('.drawing-tool').removeClass('active');
      $('#circle-tool').addClass('active');
      draw.changeMode('draw_circle');
      console.log("Circle tool selected.")
    });

  $("#select-tool").on('click', function () {
    $('.drawing-tool').removeClass('active');
    $(this).addClass('active');
    draw.changeMode('simple_select');
    console.log("Select tool selected.")
  });

  $("#delete-tool").on('click', function () {
    draw.trash();
    console.log("Polygon(s) deleted.");
    displaySelectionChange();
  });

//MAP

  function setDateRange(year) {
    var min_date = year.toString() + '-01-01';
    var max_date = year.toString() + '-12-31';
    var display_date = year.toString() + "-{{ session.default_host_removal_month|stringformat:'02i' }}-{{ session.default_host_removal_day|stringformat:'02i' }}"
    $('.management-date').attr('min',min_date);
    $('.management-date').attr('max',max_date);
    $('.management-date').val(display_date);
  }

  mapboxgl.accessToken =
      'pk.eyJ1Ijoic2hhbmtqNjg3IiwiYSI6ImNqc2pmc201eDE0amUzeXF6eTYzaDI2azUifQ.7uhVr9px-kAjXkqSdTW2OQ';
    /* eslint-disable */
  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/shankj687/ckepyeuvg2zh219s0qihd4m55', //hosted style id
    center: [{{ mapbox_parameters.longitude}}, {{ mapbox_parameters.latitude}}], // initial map center in [lon, lat]
    zoom: {{ mapbox_parameters.zoom }} // starting zoom
  });

//Initialize some variables
var year_id = '0';
var max_occurence_number_for_legend = {{ session.max_value }}; //Normalize the run collections
var map_fill_opacity = 0.6; //For occurence and forecasted data

map.on('load', function() {
  map.setLayoutProperty('airports-circles','visibility','none');
  map.setLayoutProperty('seaport-circles','visibility','none');
  map.setLayoutProperty('intermodal-passenger','visibility','none');
  map.setLayoutProperty('intermodal-freight','visibility','none');
  map.setLayoutProperty('railroad-lines','visibility','none');
  map.setLayoutProperty('truck-parking','visibility','none');
  hostmapLayer({{ host_map|safe }});
  console.log("Adding initial data.");
  {% for year in historic_data %}
    newFireLayer({{ year.data|safe }}, '{{ year.year}}', max_occurence_number_for_legend,'outputs');
  {% endfor %}
  map.setLayoutProperty({{ historic_data.last.year }}, 'visibility', 'visible');
  default_run = {{ session.default_run }};
  get_output(default_run);                      
});

var popup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
});
 
map.on('mouseenter', 'airports-circles', function (e) {
  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = 'pointer';
  
  var coordinates = e.features[0].geometry.coordinates.slice();
  
  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }
  
  // Populate the popup and set its coordinates
  // based on the feature found.
  popup.setLngLat(coordinates).setHTML('<div>'+e.features[0].properties.FAA_ID+' Airport</div>' +
      '<p> Arrivals: ' + e.features[0].properties.ARRIVALS + '</p>' +
      '<p> Departures: ' + e.features[0].properties.DEPARTURES + '</p>'
      ).addTo(map);
});
 
map.on('mouseleave', 'airports-circles', function () {
  map.getCanvas().style.cursor = '';
  popup.remove();
});

//Some events that might be useful to use in the future:
//map.on('move', function() {
//  console.log('Map is being moved')
//})

//map.on('moveend', function() {
//  console.log('MOVEEND')
//})

//map.on('movestart', function() {
//  console.log('MOVESTART')
//})

//Set initial draw color and settings, add Draw functionality to the map.
var draw_color = colors[0];
var host_removal_pattern=host_removal_patterns[0];
var pesticide_application_pattern=pesticide_application_patterns[0];
draw = setDrawColor(draw_color,host_removal_pattern,pesticide_application_pattern);
map.addControl(draw);

//Draw fires a number of events. All of these events are namespaced with draw. 
//and are emitted from the Mapbox GL JS map object. 
//All events are all triggered by user interaction.
//Here we are giving the draw events custom functions to perform when triggered.
map.on('draw.create', createPolygon);
map.on('draw.delete', deletePolygons);
map.on('draw.update', updatePolygons);
map.on('draw.selectionchange', displaySelectionChange);
//Mapbox draw automatically switches to select tool after drawing a polygon.
//This function makes it so that the mode stays as polygon if the polygon
//tool is selected.
map.on('draw.modechange', e => {
      if ($("#polygon-tool").hasClass("active")){
    draw.changeMode('draw_polygon');
  }
});

//Reset view to case study zoom and center
$("#reset-view-tool").on('click', function () {
  map.flyTo({
    center: [{{ mapbox_parameters.longitude}}, {{ mapbox_parameters.latitude}}], // initial map center in [lon, lat]
    zoom: {{ mapbox_parameters.zoom }}, // starting zoom
    pitch: 0,
    bearing: 0
  });
});

//editPolygons popup button click
$("#changeManagementButton").on('click', function () {
  changePolygonProperties();
});


//The following two sections should be heavily modified with the changes to the
//management polygons and properties. There will no longer be budget and cost, but
//there will still be an area unit and cost modifier...
$( "select#id_area_unit" ).on( "click blur load", function() {
  var abbreviated_unit_display = $("select#id_area_unit").children("option:selected").attr('data-text');
  $('#area_unit_button').html(abbreviated_unit_display);
  updateJSON();
});

//Update hidden radius_in_meters field anytime the displayed radius is updated
  $("input#displayed_circle_radius, select#circle_distance_unit").on('click blur', function () {
      updateCircleRadiusInMeters();
  });
//Update hidden cost per meter squared when displayed cost is updated
$(".management_group_cost input, .management_group_cost select").on("click blur hide.bs.dropdown", function() {
  element = $(this).parent();
  updateDefaultManagementCost(element);
});

//Prevent dropdown inputs for draw tools from closing on click
$('.draw-tool-dropdown').on('click', function(e) {
  e.stopPropagation();
});

//Prevent no management type from being selected
$(".management-type").on('change',  function () {
  //If all management types are unchecked, recheck the last unchecked checkbox
  if ($('.management-type:not(:checked)').length == $('.management-type').length ){
    $(this).prop('checked',true)
	}
});

function round(value, decimals) {
  return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
}

//RIGHT SIDE PANEL
$('#show_details_button, #hide_details_button').on('click', function () {
  var bounds = map.getBounds();
  $('#map-container-new-view').toggleClass('col-md-9 col-md-12');
  $('#side-panel').toggleClass('d-md-block d-md-none');
  map.resize();
  $('#show_details_button').toggle("fast");
});

//DISPLAY OPTIONS PANEL
$('#show_display_options_button').on('click', function () {
  console.log('Display options panel clicked')
  //$('#side-panel').toggleClass('d-md-block d-md-none');
  $('#show_display_options_button i#display_options_button_icon').toggleClass("fa-chevron-down fa-chevron-up");
  $('#display-options-panel').toggle();
});

//I don't think this is used anymore... check
  $('#map-tab').on('shown.bs.tab', function () {
    console.log("Map tab selected.")
        map.resize();
    });

//Not sure if this is used anymore either
  $('#chart-view-tab').on('shown.bs.tab', function () {
    });

function update_displayed_data() {
  var year_id = $('#year-slider').find('input').val();
  var min_year = $("#year-slider input").attr('min');
  var max_year = $("#year-slider input").attr('max');
  for (i = parseInt(min_year); i <= parseInt(max_year); i++) {
    if (i <= {{ historic_data.last.year }}) {
      //Hide historic data years
      var hide_layer_name = i;
      if (map.getLayer(hide_layer_name)) {
        map.setLayoutProperty((hide_layer_name), 'visibility', 'none');
      }
      else {
        console.log(hide_layer_name + " does not exist")
      }      
    }
    else {
      //Hide data years
      var x;
      for (x in displayed_data_types) {
        var hide_layer_name = i + displayed_data_types[x];
        if (map.getLayer(hide_layer_name)) {
          map.setLayoutProperty((hide_layer_name), 'visibility', 'none');
        }
        else {
          console.log(hide_layer_name + " does not exist")
        }
      }
    }
    var treatment_fill = (i.toString() + "_fill");
    if (map.getLayer(treatment_fill)) {
      if (year_id >= i) {
        map.setLayoutProperty(treatment_fill, 'visibility','visible');
      }
      else {
        map.setLayoutProperty(treatment_fill, 'visibility','none');
      }
    };    
  }
  if (year_id <= {{ historic_data.last.year }}) {
    //Show the historic data for the year
    var layer_name = year_id;
    $('#display_year_forecast').text('Field observations');
    $('#legend_description').text(' (Number of detections)');
    $('#historic-legend-container').show();
    $('#occurence-legend-container').hide();
    $('#probability-legend-container').hide();
  }
  else {
    //Show the selected forecast data
    var displayed_map_type = $('input[name="displayed_data_type"]:checked').val();
    var displayed_map_name = $('input[name="displayed_data_type"]:checked').data('name');
    var layer_name = year_id + displayed_map_type;
    if (displayed_map_type == "_forecast") {
      $('#display_year_forecast').text('Forecast');
      $('#legend_description').text(' (Probability of occurence)');
      $('#historic-legend-container').hide();
      $('#occurence-legend-container').hide();
      $('#probability-legend-container').show();    
    }
    else {
      $('#display_year_forecast').text(displayed_map_name);
      $('#legend_description').text(' (number)');
      $('#historic-legend-container').hide();
      $('#occurence-legend-container').show();
      $('#probability-legend-container').hide();        
    }
  }
  console.log('Displaying layer: ' + layer_name);
  if (map.getLayer(layer_name)) {
    map.setLayoutProperty(layer_name, 'visibility', 'visible');
  }
  else {
    alert('The layer ' + layer_name + ' does not exist.')
  }
  $("#displayYear").val(year_id);
}

$("#year-slider").change(function () {
  //year_id = $(this).find('input').val();
  update_displayed_data();

  //var steering_year = parseInt($(".timeline-year-container.year_active").attr('data-year-value'));
});

var most_recent_run = 0;

function get_run_collection(run_collection_id) {
  console.log('GETTING RUN COLLECTION ' + run_collection_id +'.');
  $('#tangible-landscape-listener-button a').attr('data-value','false');
  $('#tangible-landscape-listener-button a').text('Resume listening');  
  $.ajax({
    url: "{% url 'get_run_collection' %}",
    dataType: "json",
    data: {
      'run_collection_id': run_collection_id
    },
    success: function (data) {
      console.log('Success getting run collection ' + run_collection_id + '.')
      $('#run-collection-name span').text(data.name);
      $('#run-collection-name').attr('data-run-collection-pk',data.pk);
      $('#input_run_name span').text(data.name);
      $("#new_run_collection_name").val(data.name);
      $('#input_run_pk span').text(data.pk);
      $('#input_description span').text(data.description);
      $('#new_run_collection_description').val(data.description);
      $('#input_status span').text(data.status);
      $('#input_random_seed span').text(data.random_seed);
      $('#input_date_created span').text(data.date_created);
      $('#input_budget span').text(data.budget);
      $('input#id_budget').val(data.budget);
      $('#input_tangible_landscape span').text(data.tangible_landscape);
      $('#id_run_collection').val(data.pk);    
      $(".timeline-year-container").removeClass("year_active").addClass("management_not_started").removeClass("management_active").removeClass("management_complete");
      //$(".timeline-year-container.management_active").removeClass("management_active").addClass("management_complete").addClass("year_active").next().next(".timeline-year-container").removeClass("management_not_started").addClass("management_active");
      $(".timeline-year-container.year-0").addClass("management_complete").removeClass("management_not_started");
      if (data.inputs.length == 0){
        $(".timeline-year-container.year-0").addClass("year_active");
        default_run = {{ session.default_run }};
        console.log("Loading default run: " +default_run);
        get_output(default_run);        
        $(".timeline-year-container.year-1").removeClass("management_not_started").addClass("management_active");
        most_recent_run = 0;
        setDateRange({{ historic_data.last.year }} + 1);
      }
      else {
        //Loop through the steering years
        for (var i = 0; i < data.inputs.length; i++) {
          var steering_year = data.inputs[i].steering_year;
          var next_steering_year = steering_year + 1;
          var run_id = data.inputs[i].pk;
          $(".timeline-year-container[data-year-value="+steering_year+"]").attr('data-run-pk',run_id);
          $(".timeline-year-container[data-year-value="+steering_year+"]").removeClass("management_not_started").addClass("management_complete");
        // Do something if is the last iteration of the loop
          if((i + 1) == (data.inputs.length)){
            $(".timeline-year-container[data-year-value="+steering_year+"]").addClass("year_active")
            $(".timeline-year-container[data-year-value="+next_steering_year+"]").removeClass("management_not_started").addClass("management_active");
            setDateRange(next_steering_year);
            get_output(run_id);
            most_recent_run=run_id;
          }
        };
      }
    if (data.tangible_landscape) {
      console.log('Tangible landscape is on.')
      //hide run buttons
      $(".timeline-year-container").find(".submit_run_button").hide();
      $("#tangible-landscape-listener-button").show();
      $("#tangible-landscape-listener-button a").attr('data-value','true');
      $("#tangible-landscape-listener-button a").text('Stop listening');     
      listen_for_new_runs(run_collection_id,most_recent_run);
      //if new run, get output for new run
    }
    else {
      //console.log('Tangible landscape is false.')
      $(".timeline-year-container").find(".submit_run_button").show();
      $("#tangible-landscape-listener-button").hide();
      var year_count = parseInt($(".timeline-year-container.management_active").attr('data-year-counter'));
      //console.log('Updating draw color to ' + year_count);
      updateDrawColor(year_count);
    }
    updateActiveUser(run_collection_id);
    },
    error: function (xhr) {
      console.log('Failed getting run collection.')
      alert(xhr.statusText)
    }
  });
};

var spread_rate;
var max_spread_rate=0;

function get_output(run_id) {
  //Remove any drawn management on the dashboard before loading new data
  draw.deleteAll();
  $('#id_management_polygons').val(0);
  updateDrawMetrics();
  console.log('GETTING OUTPUT FOR RUN: ' + run_id);
  $('#status-text span').text('Loading...');
  $("#status-indicator").show();
  $("#status-indicator-shading").show();
  $("#year-slider").find('input').val('{{ historic_data.last.year }}');
  $("#year-slider input").attr('max', '{{ historic_data.last.year }}');
  $("#displayYear").val('{{ historic_data.last.year }}');
  map.setLayoutProperty('{{ historic_data.last.year }}', 'visibility', 'visible');
  //Make this loop a function of current slider max
  for (i = {{ steering_years | first }}; i < ({{ steering_years | last }} + 1); i++) {
    //console.log('Removing layers and sources for year: ', i);
    var x;
    for (x in displayed_data_types) {
      var layer_name = i + displayed_data_types[x];
      if (map.getLayer(layer_name)) {
        map.removeLayer(layer_name);
        //console.log('Removing layer: ' + layer_name)
      }
      if (map.getSource(layer_name)) {
        map.removeSource(layer_name);
      };
    }

    var treatment_outline = (i.toString() + "_management");
    var treatment_fill = (i.toString() + "_fill");
    //console.log('Removing existing drawn management.');
    if (map.getLayer(treatment_fill)) {
      map.removeLayer(treatment_fill);
    };
    if (map.getSource(treatment_outline)) {
      map.removeSource(treatment_outline);
    };
  };
  console.log("Requesting run " + run_id + " data from the database.")
  $.ajax({
    url: "{% url 'get_output' %}",
    dataType: "json",
    data: {
      'new_run_id': run_id
    },
    success: function (data) {
      console.log('Run ' + data.run_inputs.primary_key + ' data successfully retrieved from database.');
      $(".timeline-year-container").find(".timeline-visibility").show();
      $(".timeline-year-container.year_active").nextAll(".timeline-year-container").find(".timeline-visibility").hide();
      var year_list = [],
        infected_area_list = [],
        infected_number_list = [];
      var max_year = {{ historic_data.last.year }};
      var min_year = {{ historic_data.first.year }};
      var button_area = 0;
      var button_number_infected = 0;
      var steering_year = data.run_inputs.steering_year;
      spread_rate = data.spread_rate;
      max_spread_rate = data.max_spread_rate;
      for (var i = 0; i < data.results.length; i++) {
        var year = data.results[i].year;
        //console.log("Adding output " + data.results[i].pk + ' for year ' + year);

        var year_string = year.toString();
        if (data.results[i].median_spread_map) {
          var probability_map_data = data.results[i].median_spread_map;
          var probability_layer_name = year_string + "_forecast";
          newMagmaLayer(probability_map_data, probability_layer_name, 100,'probability');
        } 
        if (data.results[i].median_spread_map) {
          var median_map_data = data.results[i].median_spread_map;
          var median_layer_name = year_string + "_median";
          newFireLayer(median_map_data, median_layer_name, max_occurence_number_for_legend,'median');
        }
        if (data.results[i].median_spread_map) {
          var maximum_map_data = data.results[i].median_spread_map;
          var maximum_layer_name = year_string + "_maximum";
          newFireLayer(maximum_map_data, maximum_layer_name, max_occurence_number_for_legend,'max');
        }
        if (data.results[i].median_spread_map) {
          var minimum_map_data = data.results[i].median_spread_map;
          var minimum_layer_name = year_string + "_minimum";
          newFireLayer(minimum_map_data, minimum_layer_name, max_occurence_number_for_legend,'min');
        }
        if (data.results[i].median_spread_map) {
          var mean_map_data = data.results[i].median_spread_map;
          var mean_layer_name = year_string + "_mean";
          newFireLayer(mean_map_data, mean_layer_name, max_occurence_number_for_legend,'mean');
        }
        if (data.results[i].median_spread_map) {
          var stdev_map_data = data.results[i].median_spread_map;
          var stdev_layer_name = year_string + "_stdev";
          newFireLayer(stdev_map_data, stdev_layer_name, max_occurence_number_for_legend,'standard_deviation');
        }

        year_list.push(data.results[i].year);
        infected_area_list.push(data.results[i].infected_area);
        infected_number_list.push(data.results[i].number_infected);
        //Add new run button if there is steering or update existing button
        if (data.steering) {
          if ((i + 1) == (data.results.length)) {
            var run_collection_pk = $('#run-collection-name').attr('data-run-collection-pk');
            var run_collection_name = $('#input_run_name span').text();
            var run_collection_description = $('#input_description span').text();
            var run_collection_date = $('#input_date_created span').text(data.date_created);
            var run_collection_budget = $('#input_budget span').text(data.budget);
            insertRunButton(run_collection_pk.toString(), run_collection_name, run_collection_date, run_collection_description, data.results[i].number_infected, data.results[i].infected_area, data.total_management_cost);
            relayout_buttons(max_number, max_area, max_cost);
          }
        }
        if (year > max_year) {
          $("#year-slider input").attr('max', year.toString());
          max_year = year;
        };
        if (year < min_year) {
          $("#year-slider input").attr('min', year.toString());
          min_year = year;
        };
      }
      var year_list = [],
        infected_area_list = [],
        infected_number_list = [];
      if (data.steering) {
        var display_year = data.run_inputs.steering_year;
        setDateRange(display_year + 1);
        $("#year-slider").find('input').val(display_year.toString());
        $("#displayYear").val(display_year.toString());
        update_displayed_data();
      };
      var defaults = data.no_management_default;
      var steering_outputs = data.all_steering_years;
      var initial_infected_area = {{ historic_data.last.infected_area }};
      var initial_number_infected = {{ historic_data.last.number_infected }};
      var first_year = {{ steering_years | first }};
      //console.log('First year = ', first_year);
      var last_year = {{ steering_years | last }};
      //console.log('Last year = ', last_year);
      budget_plot(defaults, steering_outputs, first_year, last_year);
      area_plot(defaults, steering_outputs, initial_infected_area, initial_number_infected, first_year, last_year);
      //spreadRatePlot({{historic_data.last.year}});
      //I think this loop is unnecessary
      //for (var i = 0; i < data.all_steering_years.length; i++) {
      //console.log('Sanity check: ' + i)
      //};
      $("#status-indicator").hide();
      $("#status-indicator-shading").hide();
      for (var i = 0; i < data.inputs.length; i++) {
        if (data.steering) {
          if (data.run_inputs.steering_year >= data.inputs[i].steering_year) {
            var treatment_outline = (data.inputs[i].steering_year.toString() + "_management");
            var treatment_fill = (data.inputs[i].steering_year.toString() + "_fill");
            if (map.getLayer(treatment_fill)) {
              map.removeLayer(treatment_fill);
            };
            if (map.getSource(treatment_outline)) {
              map.removeSource(treatment_outline);
            };
            map.addSource(treatment_outline, {
              'type': 'geojson',
              /*many types of data can be added, such as geojson, vector tiles or raster data*/
              'data': data.inputs[i].management_polygons,
            });
            /*here we are adding a source, then a layer based on that that source*/

            map.addLayer({
              "id": treatment_fill,
              "type": 'fill',
              "source": treatment_outline,
              "paint": {
                'fill-pattern': [
                  "case",
                  ['==', ['get', "management_type"], "Host removal"], host_removal_patterns[i],
                  ['==', ['get', "management_type"], "Pesticide"], previous_pesticide_application_patterns[i],
                  ''
                ],
                "fill-opacity": 1.0
              }
            });
          };
        };
      };
    },
    error: function (xhr) {
      alert(xhr.statusText)
    }
  });
};



$("#tangible-landscape-listener-button a").on('click', function () {
  if ($(this).attr('data-value') == 'true') {
    $(this).attr('data-value', 'false');
    console.log("Changing value of TL listener to false.");
    $(this).text('Resume listening');
  } else {
    $(this).attr('data-value', 'true');
    $(this).text('Stop listening');
    console.log("Changing value of TL listener to true.");
    var run_collection_id = $('#run-collection-name').attr('data-run-collection-pk');
    listen_for_new_runs(run_collection_id, 0);
  }
});

function listen_for_new_runs(run_collection_id, most_recent_run) {
  $('#tangible-landscape-indicator').fadeIn();
  var active_run_collection_id = $('#run-collection-name').attr('data-run-collection-pk');
  console.log('Active run collection id = ' + active_run_collection_id);
  var continue_listening = $('#tangible-landscape-listener-button a').attr('data-value');
  if (active_run_collection_id == run_collection_id) {
    setTimeout(function () {
      $.ajax({
        url: "{% url 'check_for_new_TL_run' %}",
        dataType: "json",
        data: {
          'run_collection_id': run_collection_id
        },
        success: function (data) {
          console.log("The most recent run for run_collection " + run_collection_id + " is: " + data.most_recent_run_pk);
          //Check if the most_recent_run has changed, update dashboard if it has.
          $('#tangible-landscape-indicator').fadeOut("slow");
          if (most_recent_run != data.most_recent_run_pk) {
            get_run_collection(run_collection_id);
          } else if (continue_listening == 'false') {
            console.log("Exiting TL listening loop.")
            $('#tangible-landscape-listener-button a').attr('data-value');
          } else {
            //Setup the next poll recursively
            listen_for_new_runs(run_collection_id, data.most_recent_run_pk);
          }
        },
        error: function (xhr, errmsg, err) {
          alert("An error has occured: " + xhr.status + "\nError: " + xhr.responseText +
            "\nThere was a problem listening for the results of the model run... the simulation is most likely still running. Try refreshing the page in 1-2 minutes.");
          console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
      });
    }, 2000);
  };
};

//Changes to the page for tangible landscape.
$("input#id_tangible_landscape").on('change', function () {
  if ($('input#id_tangible_landscape').prop('checked')){
    console.log('Tangible landscape is on...');
      $("#submit-run-button").text("Send to Tangible Landscape");
      disableDrawTools();
  }
  else {
    console.log('Tangible landscape is off...');
    $("#submit-run-button").text("Run PoPS Model");
    enableDrawTools();
  }
});

$("#host_map_checkbox input").on('change', function () {
  if ($('#host_map_checkbox input').prop('checked')){
    console.log('Show host map');
    map.setLayoutProperty('host_map','visibility','visible');
  }
  else {
    console.log('Hide host map');
    map.setLayoutProperty('host_map','visibility','none');
  }
});

$("#airports_checkbox input").on('change', function () {
  if ($('#airports_checkbox input').prop('checked')){
    console.log('Show airports');
    map.setLayoutProperty('airports-circles','visibility','visible');
  }
  else {
    console.log('Hide airports');
    map.setLayoutProperty('airports-circles','visibility','none');
  }
});

$("#seaports_checkbox input").on('change', function () {
  if ($('#seaports_checkbox input').prop('checked')){
    console.log('Show seaports');
    map.setLayoutProperty('seaport-circles','visibility','visible');
  }
  else {
    console.log('Hide seaports');
    map.setLayoutProperty('seaport-circles','visibility','none');
  }
});

$("#intermodal_passenger_checkbox input").on('change', function () {
  if ($('#intermodal_passenger_checkbox input').prop('checked')){
    console.log('Show passenger');
    map.setLayoutProperty('intermodal-passenger','visibility','visible');
  }
  else {
    console.log('Hide passenger');
    map.setLayoutProperty('intermodal-passenger','visibility','none');
  }
});

$("#intermodal_freight_checkbox input").on('change', function () {
  if ($('#intermodal_freight_checkbox input').prop('checked')){
    console.log('Show freight');
    map.setLayoutProperty('intermodal-freight','visibility','visible');
  }
  else {
    console.log('Hide freight');
    map.setLayoutProperty('intermodal-freight','visibility','none');
  }
});

$("#railroad_lines_checkbox input").on('change', function () {
  if ($('#railroad_lines_checkbox input').prop('checked')){
    console.log('Show railroads');
    map.setLayoutProperty('railroad-lines','visibility','visible');
  }
  else {
    console.log('Hide railroads');
    map.setLayoutProperty('railroad-lines','visibility','none');
  }
});

$("#truck_parking_checkbox input").on('change', function () {
  if ($('#truck_parking_checkbox input').prop('checked')){
    console.log('Show seaports');
    map.setLayoutProperty('truck-parking','visibility','visible');
  }
  else {
    console.log('Hide seaports');
    map.setLayoutProperty('truck-parking','visibility','none');
  }
});

    $(".delete_run_collection").on('click', function () {
   //var run_collection_pk = $('#run-collection-name').attr('data-run-collection-pk');
      event.stopPropagation(); 
      var run_collection_pk = $(this).parents('.run-link').attr('data-run-collection');
      console.log("Deleting run_collection " + run_collection_pk);
        $.ajax({
          url: "{% url 'delete_run_collection' %}",
          dataType: "json",
          data: {
            'run_collection': run_collection_pk,
          },
          success: function (data) {
            $(".run-link[data-run-collection='" + data.run_collection_id +"']").remove();
            //get_output(previous_run_id);
          },
          error : function(xhr,errmsg,err) {
          alert("An error occured deleting the runs. An error has occured: " + xhr.status + "\nError: " + xhr.responseText 
          + "\n");
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
        });
    });    

    $("#edit_run_collection").on('click', function () {
   //var run_collection_pk = $('#run-collection-name').attr('data-run-collection-pk');
      event.stopPropagation(); 
      var run_collection_pk = $('#run-collection-name').attr('data-run-collection-pk');
      var run_collection_name = $('#new_run_collection_name').val();
      var run_collection_description = $('#new_run_collection_description').val();
      console.log("Editing run_collection " + run_collection_pk);
        $.ajax({
          url: "{% url 'edit_run_collection' %}",
          dataType: "json",
          data: {
            'run_collection': run_collection_pk,
            'name': run_collection_name,
            'description': run_collection_description
          },
          success: function (data) {
            console.log('Run Collection ' + data.run_collection_id + ' was edited.');
            get_run_collection(data.run_collection_id);
            $('#edit_run_name_modal').modal('hide');
          },
          error : function(xhr,errmsg,err) {
          alert("An error occured deleting the runs. An error has occured: " + xhr.status + "\nError: " + xhr.responseText 
          + "\n");
              console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
          }
        });
    });    

    /*
    $("#map-tab").on('click', function () {
      $("#submit-run-button").attr("disabled", false);
      $("input#id_name").prop('disabled', false);
      $( "#run-details" ).show();
      $("a.nav-link").removeClass("active");
      $("a#map-tab").addClass("active");
      $(".tab-pane").removeClass("active");
      $("#v-pills-map").addClass("active");
      enableDrawTools();
    });
    */
    $("#submit-run-collection").on('submit', function () {
      console.log("SUBMITTING NEW RUN COLLECTION TO DATABASE.");
      event.preventDefault();
      //$("#submit-run-button").attr("disabled", true);
      //$('#run-preview-container button').removeClass('active');
        var form = $("#submit-run-collection");
        if ($('input[name="name"]').val() == "Default_name") {
          console.log('DEFAULT NAME DETECTED... CHANGING');
          var now_date = new Date();
          var now_time =  now_date.getHours() + ':' + now_date.getMinutes() + ':' + now_date.getSeconds();
          var date_time_name = 'New name';
          $('input[name="name"]').val(now_time);
        }
      $.ajax({
        url: form.attr("submit-run-collection-url"),
        data: form.serialize(),
        type : "POST", // http method
        success: function (data) {
          console.log('RUN COLLECTION ' + data.pk + 'SUCCESSFULLY POSTED TO DATABASE.');
          $('input[name="name"]').val("Default_name");
          var new_run_collection_id = data.pk;
          $('#editInputParameters').modal('hide');
          $('#run-collection-name span').text(data.name);
          $('#run-collection-name').attr('data-run-collection-pk',data.pk);
          $('#input_run_name span').text(data.name);
          $('#input_run_pk span').text(data.pk);
          $('#input_description span').text(data.description);
          $('#input_status span').text(data.status);
          $('#input_random_seed span').text(data.random_seed);
          $('#input_date_created span').text(data.date_created);
          $('#input_budget span').text(data.budget);
          $('#input_tangible_landscape span').text(data.tangible_landscape);
          $('#id_run_collection').val(data.pk);
          get_run_collection(new_run_collection_id);
        },
        error : function(xhr,errmsg,err) {
        alert("An error has occured: " + xhr.status + "\nError: " + xhr.responseText 
        + "\nIf the displayed error is not informative, the most likely issue is that there was a problem writing to the database.");
            console.log('There was an error writing to the database:' + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
      });
    });

$("#submit-run").on('submit', function () {
  event.preventDefault();
  if ($('input#id_run_collection').val() == "0") {
    alert('You must create a run collection before submitting a run. Use the "+" icon in the right side panel.')
    return;
  }
  var steering_year = parseInt($(".timeline-year-container.management_active").attr('data-year-value'));
  var year_count = parseInt($(".timeline-year-container.management_active").attr('data-year-counter'));
  console.log('SUBMITTING NEW RUN WITH MANAGEMENT IN ' + steering_year);
  $('#id_steering_year').val(steering_year);
  var form = $("#submit-run");
      $.ajax({
        url: form.attr("submit-run-url"),
        data: form.serialize(),
        type : "POST", // http method
        success: function (data) {
          var new_run_id = data.pk;
          console.log('RUN ' + new_run_id + ' (Management Year: ' + data.steering_year + ') DATA SUCCESSFULLY POSTED TO DATABASE');
          $(".timeline-year-container.management_active").attr('data-run-pk',new_run_id);
          var new_run_collection_id = $('#run-collection-name').attr('data-run-collection-pk');
          var case_study_id = {{ case_study.pk }};
          var session_id = {{ session.pk }};
          if (!$('input#id_tangible_landscape').prop('checked')) {
             console.log('ATTEMPTING TO RUN POPS MODEL API FOR RUN ' + new_run_id + ' IN RUN COLLECTION ' + new_run_collection_id);
             var base_url = "https://pops-model-api.ngrok.io"
             // https://d421f4b2cc79.ngrok.io/status?case_study_id=2&session_id=2&run_collection_id=25&run_id=40
             //"https://pops-model-api.appspot.com/status?case_study_id=2&run_id="; //"https://pops-model-api.appspot.com/status?case_study_id=2&run_id=";//https://test-dot-pops-model-api.appspot.com/status?case_study_id=2&run_id=";
             var run_url = (base_url + "/status?case_study_id=" + case_study_id.toString() + "&session_id=" + session_id.toString() + "&run_collection_id=" + new_run_collection_id.toString() + "&run_id=" + new_run_id.toString()) ;
             console.log('Using URL: ' + run_url);
             //chatSocket.notify("run_pops", {
              //run_id: new_run_id,
              //run_collection: new_run_collection_id,
            //})
             $.ajax({
              url: run_url,
              dataType: 'JSONP',
              type: 'GET',
              headers: { 'Access-Control-Allow-Origin': base_url },
              statusCode: {
                404: function() {
                  alert( "PoPS Model API not found (404 error)... \n Please try again. \n If the problem persists, contact an admin." );
                },
                500: function() {
                  alert( "PoPS Model API returned 500 Error... \n Please try again. \n If the problem persists, contact an admin." );
                }
              },
              success : function (data) {
                console.log('Success signal from PoPS Model API.');
              },
              error : function(xhr,errmsg,err) {
                console.log('Received status from the PoPS model API:' + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
              }
             });
             console.log('Sent run request to PoPS. Waiting for updates to database...')
          }
          else {
            console.log('Waiting for management from tangible landscape...')
          }
          $("#submit-run-button").attr('data-run',new_run_id); //I think this is obsolete
        },
                // handle a non-successful response
        error : function(xhr,errmsg,err) {
      alert("An error has occured: " + xhr.status + "\nError: " + xhr.responseText 
      + "\nIf the displayed error is not informative, the most likely issue is that there was a problem writing to the database.");
            console.log('There was an error writing to the database:' + xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
      });
  $("#status-indicator").show();
  $("#status-indicator-shading").show();
});

function relayout_buttons(max_number,max_area,max_cost) {
  var update = {
    'yaxis.range': [0, max_number],
    'yaxis2.range': [0, max_area*acre_to_meter_ratio],
    'yaxis3.range': [0, max_cost],
  };
  var idArray = [];
  $('.comparison_plot').each(function () {
    idArray.push(this.id);
  });
  //console.log('Updating y-axis values of buttons.')

  for (i = 0; i < idArray.length; i++) {
    Plotly.relayout(idArray[i], update);
  }
};

// *WEBSOCKETS*
//Initiate websocket
const session = {{ session.pk }};
var ws_scheme = window.location.protocol == "https:" ? "wss://" : "ws://";
var chatSocket = new RPCWebSocket.Client(
  ws_scheme +
  window.location.host +
  '/ws/dashboard/' +
  session +
  '/', {
    max_reconnects: 0, // Unlimited
  });

//Receive updated management from server
chatSocket.on("update_management", (event) => {
  console.log("New management polygons received for run collection " + event.run_collection)
  //console.log(event);
  document.querySelector('#id_management_polygons').value = (event.management_polygons);
  //console.log($('#id_run_collection').val());
  //console.log(event.run_collection)
  //if current run collection is the even run collection, update management
  if ($('#id_run_collection').val() == event.run_collection){
    var treatment = JSON.parse(event.management_polygons);
    //console.log('Treatment:')
    //console.log(treatment)
    if (treatment != 0) {
      var ids = draw.set(treatment);
    } else {
      draw.deleteAll();
    }
    updateDrawMetrics();
    if ($("#polygon-tool").hasClass("active")) {
      draw.changeMode('draw_polygon');
    }          
  }
});

//New run collection
chatSocket.on("new_run_collection", (event) => {
  console.log("---NEW RUN COLLECTION---")
  console.log(event);
  run_collection_id = event.run_collection;
  name = event.name;
  date = event.date;
  description = event.description;
  insertRunButton(run_collection_id, name, date, description, 0, 0, 0)
});

//This will be obsolete when run_status_update is complete
//chatSocket.on("run_pops", (event) => {
 // console.log('Someone clicked the Run PoPS button')
  //console.log(event);
  //run_collection = event.run_collection;
  //new_run_id = event.run_id;
  //if ($('#id_run_collection').val() == run_collection){
 // }
//})

//Send management to new user in Run Collection
chatSocket.on("send_management_request", (event) => {
  console.log("Requesting management for run collection " + event.run_collection)
  //console.log(event);
  if ($('#id_run_collection').val() == event.run_collection & $('#id_management_polygons').val() != 0){
    sendJSONWebsocket();
  }
});

//Send management to newly connected user
chatSocket.on("new_connection_detected", (event) => {
  console.log("New user added")
  console.log(event);
});

//Send management to newly connected user
chatSocket.on("connection_removed", (event) => {
  console.log("User exited")
  console.log(event);
});

//Run status updated
chatSocket.on("run_status_update", (event) => {
  console.log("Run status updated")
  console.log(event);
  if ($('#id_run_collection').val() == event.run_collection) {
    console.log('--RUN STATUS CHANGED to ' + event.status + '--')
    $("#status-indicator").show();
    $("#status-indicator-shading").show();
    $('#status-text span').text(event.status);
    if (event.status == "SUCCESS") {
      $('#id_management_polygons').val(0);
      get_output(event.run_pk);
      steering_year = event.year;
      var year_count = parseInt($("div.timeline-year-container[data-year-value='" + event.year + "']").attr('data-year-counter'));
      var new_management_year= year_count+1;
      $(".timeline-year-container").removeClass("year_active").removeClass("management_active").removeClass("management_complete");
      for (var year = 0; year < year_count+1; year++) { 
        $("div.timeline-year-container[data-year-counter='" + year + "']").addClass("management_complete");
      }
      $("div.timeline-year-container[data-year-counter='" + year_count + "']").addClass("year_active");
      $("div.timeline-year-container[data-year-counter='" + new_management_year + "']").removeClass("management_not_started").addClass("management_active");
      //$(".timeline-year-container.management_active").removeClass("management_active").addClass("management_complete").addClass("year_active").next().next(".timeline-year-container").removeClass("management_not_started").addClass("management_active");
      //Remove year_active, management_active from all
      var next_year_count = parseInt(year_count) + 1;
      updateDrawColor(next_year_count);
    }
    if (event.status == "FAILED") {
      $("#status-logo").hide();
    }
  }
  else {
    console.log('Run status changed in a different run collection.')
  }
});

//Send management to newly connected user
{% comment %} 
  chatSocket.on("update_user", (event) => {
  console.log("user changed run collection")
  console.log(event);
  run_collection = event.run_collection;
  const run_button = document.querySelector('#run_button_'+run_collection);
  //run_button.dataset.activeUsers="shannon,chris";
  //all_active_users = run_button.dataset.activeUsers;
  console.log($("#run_button_"+run_collection).data("active-users"));
  if ($("#run_button_"+run_collection).data("active-users")) {
  var activeUserList = $("#run_button_"+run_collection).data("active-users").split(",");
  }
  else {
   var activeUserList = [];
  }

  //console.log(storedArray);
  activeUserList.push(event.user);
  //console.log(storedArray);
  //const filteredItems = storedArray.filter(item => item !== 'chris')
  //console.log(filteredItems);
  run_button.dataset.activeUsers=JSON.stringify(activeUserList);
  console.log(run_button);

}); {% endcomment %}

function updateActiveUser(run_collection) {
  console.log('Sending websocket message')
  chatSocket.notify("update_user", {
    user: '{{ user.username }}',
    run_collection: run_collection,
  })
};

//This function sends the polygon JSON via websocket 
function sendJSONWebsocket() {
  console.log('Sending websocket message')
  const messageInputDom = document.querySelector('#id_management_polygons');
  const management_polygons = messageInputDom.value;
  chatSocket.notify("update_management", {
      management_polygons: management_polygons,
      run_collection: $('#id_run_collection').val(),
    })
  messageInputDom.value = ''; //should I remove this...?
}

//This function sends the polygon JSON via websocket 
function getThisRunCollectionManagement(run_collection_id) {
  console.log('Requesting management from server')
  chatSocket.notify("send_management_request", {
      run_collection: run_collection_id,
    })
}

//Websocket close event
chatSocket.on("close", (event) => {
  console.log('Websocket closed.')
});
//Websocket open event
chatSocket.on("open", (event) => {
  console.log('Websocket opened.')
});
//Websocket error event
chatSocket.on("error", (event) => {
  console.log('Websocket error.')
});


//This function updates the GeoJSON management field 
//and sends the websocket if needed
function updateJSON() {
  console.log("Updating management polygons JSON.");
  var data = draw.getAll();
  if (data.features.length > 0) {
    // Stringify the GeoJson
    var convertedData = JSON.stringify(data);
  } else {
    var convertedData = 0;
  }
  $('#id_management_polygons').val(convertedData);
  sendJSONWebsocket();
  updateDrawMetrics(); //consider removing this since it gets updated with the websocket message
}

$( document ).ready(function() {
  updateDrawMetrics();
  $( "#status-indicator" ).hide();
  $( "#status-indicator-shading" ).hide();
  relayout_buttons(max_number,max_area,max_cost);
  $('[data-toggle="pill"],[data-toggle="tooltip"],[data-toggle="tool"]').tooltip({
    trigger: 'hover'
  });
  $(function () {
    $('[data-toggle="popover"]').popover({boundary: 'viewport', html: true, trigger: 'hover focus', template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-header"></div><div class="popover-body"></div></div>'})
  });
});
  </script>
  {% endblock %}
</body>
</html>